# 総仕上げ

これまでの知識を使って簡単なウェブサービスを作っていきましょう。

## ロードマップ

* なんとなく仕様を決める(ex: 素数を数えるサービス)
* 仕様に従ってテストを書く
* テストが通るコードを書く
* テストが通るか確認する
* コードを美しく洗練させる

## なんとなく仕様を決める

仕様を決める際は、具体的で測定可能なものがテストしやすく分かりやすいです。どこまでテストするかは、どこまで自分が安心したいかの裏返しなので粒度に困ったときはそこに立ち返って考えてみると決定しやすいです。

ex:

* /1 -> 1
* /2 -> 2
* /3 -> 3
* /4 -> 5
* /a -> error

## 仕様に従ってテストを書く

簡単なWebサービスを作る際には Supertest を使うとルーティングのテストなどができて便利です。

https://github.com/visionmedia/supertest

```app.coffee``` で ```app``` を ```export``` しておきます。

```
app = module.exports = express()
```

```tests``` というディレクトリを作って ```app.test.coffee``` で

```
app = require "../app"
req = require "supertest"
should = require "should"

describe "/:num は"
	it "/1 にアクセスすると 1 を返す", (done)->
		req(app).get("/1").end (err, res)->
			res.text.should.eql 1
			done()
```

とテストコードを書いておくと、```/1``` にアクセスしたときのレスポンスをテストすることができます。

また、```POST``` したいときは

```
body =
	id: "test"
	pass: "pass"

req(app).post("/").send(body).end (err, res)->
	res...
```

のように、```send``` メソッドでデータの送信なんかもテストが可能です。

## テストが通るコードを書く

ハードコーディングでもいいので、まずはテストが通るようなコードを書いていきます。

## テストが通ることを確認する

```Grunt``` の ```Watch``` タスクなんかも利用して確認していきましょう。

## コードを美しく洗練させる

テストが通ることが確認できれば、リファクタしてもしコードが壊れたとしてもテストでキャッチすることができます。恐れずに綺麗に洗練させていきましょう。もし、バグを見つけたらバグを再現するようなテストを書き、その上でバグを潰す、というようなフローでバグフィックスするとバグフィックスを繰り返すことがなくなります。