# テスト

プログラミングにおいてテストは、テストする対象のコードが期待通りに動作することを保証するコードのことです。たとえば、入力を二乗する関数

```
mul = (x)-> x * x
```

をつくります。これは、たとえば、

```
console.log mul 2
=> 4

console.log mul 3
=> 9
```

のような結果が返ってきます。これえをテストするためには

```
if mul(2) is 4
	console.log "✔ mul(2) is 4"
else
	console.log "✘ mul(2) isnt 4"
```

というようなコードを用意しておけば少なくとも ```2``` のときの動作は保証されることがわかります。でもたとえば、```String``` の数字が入力されたらどうなるでしょうか。

```
console.log mul "2"
=> 4
```

今一瞬おやっ？っておもったひとはその感覚を大事にしてください。Javascript は掛け算のときは ```String``` 同士だと ```Number``` として計算をしてくれます。しかし、これがもし足し算だったら

```
add = (x)-> x+x

console.log "2"
=> 22
```

ファッ！？というような事態が起きます。自分のコードを強固なものにしていくために、常にコードをリファクタリングしていくことが大事です。そしてリファクタリングしたときに生じるバグ(デグレードといいます)を防ぐために、そのコードが動いていることを保証するコードを書いておけばデグレを恐れることなくリファクタリングを施すことができるわけです。

たとえば、上の例だと

```
if add("2") is 4
	console.log "✔ もし String が入力されても計算ができる"
else
	console.log "✘ String だと計算に失敗する"
```

というようなテストを書いて実行すると、もちろん失敗の方が出力されます。ここで、```add()``` をリファクタリングしましょう。

```
add = (x)->
	x = parseInt x
	x + x
```

この状態でもう一度テストコードを実行すると、テストが通っていることが確認できます。テスト駆動開発(TDD)と呼ばれる開発手法では

1. 失敗するテストを書く
2. テストが通るコードを書く
3. リファクタリングする

この3つのサイクルを回していくことで開発をしていきます。今回は簡単のため、順番を入れ替えました。テストのないコードは「レガシーコード」と呼ばれ忌み嫌われる存在なので、よほど書き捨てのスクリプトならともかく、保守していかなければならないコードにはテストを書いていく癖をつけておくと、結果的に未来の自分が救われることになるでしょう。

## mocha

上では実際のコードにまとめてテストを用意しておきましたが、実際の挙動と関係ないコードは別に分けたいです。ついでに、それぞれのモジュールに対して用意したテストコードをまとめて実行してほしいところです。そこで便利なのが ```mocha``` です。

https://github.com/visionmedia/mocha

今回は僕の好みで ```mocha``` を使いますが、他にも ```Jasmine```, ```QUnit```, ```JsUnit```, ```Buster``` なんかがあります。

さっそく、

```
$ npm install -g mocha
```

でインストールしましょう。

サンプルを用意しておいたので、

```
$ git co -b sample2 origin/sample2
```

でブランチを作成して

```
$ npm install
$ npm start
```

で動作を確認できます。

ここで、```should``` というモジュールを使っています。

https://github.com/visionmedia/should.js

これは、```Object``` を拡張して英文を記述するようにアサーションコードを書くことができるライブラリです。また、```Gruntfile.coffee``` で ```grunt-exec``` というモジュールを使っています。これは、任意のコマンドを叩けるモジュールです。これで ```mocha``` のコマンドを叩いています。これでユニットテストは可能になりました。このあたりは流派にもよりますが、僕は

```
describe "module", ->
	describe "#method", ->
		it "...", ->
		it "...", ->
	describe "#method", ->
		...
```

ぐらいの粒度でテストをするようにしています。

それでは、総仕上げとして簡単なWebサービスをつくっていきましょう。